<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Police Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 12px; background:#082032; color:white; display:flex; justify-content:space-between; align-items:center;}
    #map { height: 70vh; }
    .wrap { padding: 12px; display:grid; grid-template-columns: 2fr 1fr; gap:12px; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#efefef; margin-right:6px; font-size:12px;}
    .pill.panic { background:#ffd5d5; }
    .pill.deviation { background:#fff2cc; }
    .pill.geofence { background:#d5ffe7; }
    ul { list-style:none; padding:0; margin:0; }
    li { border-bottom:1px solid #f0f0f0; padding:8px 0; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:6px; }
    button { padding:8px 12px; border-radius:10px; border:0; background:#0a66c2; color:white; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h3>Police Dashboard</h3>
    <div>
      <button onclick="refreshTourists()">Refresh Tourists</button>
      <span id="chain"></span>
    </div>
  </header>
  <div class="wrap">
    <div class="card">
      <div id="map"></div>
    </div>
    <div class="card">
      <h4>Alerts</h4>
      <ul id="alerts"></ul>
    </div>
  </div>

<script>
let map = L.map('map').setView([26.17, 91.77], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

// Risk zone visual
L.polygon([[26.14,91.73],[26.14,91.80],[26.20,91.80],[26.20,91.73]], {color:'red'}).addTo(map).bindPopup("High-Risk Zone");

const markers = {};
function badge(t){
  if(t.type==="PANIC") return '<span class="pill panic">PANIC</span>';
  if(t.type==="DEVIATION") return '<span class="pill deviation">ROUTE</span>';
  if(t.type==="GEOFENCE") return '<span class="pill geofence">GEOFENCE</span>';
  return '<span class="pill">INFO</span>';
}

function addAlert(a){
  const li = document.createElement('li');
  const dt = new Date(a.ts*1000).toLocaleTimeString();
  li.innerHTML = `${badge(a)} <b>${a.name}</b> (${a.tourist_id.slice(0,6)}...) — ${a.msg} <br/><small>${dt}</small>`;
  document.getElementById('alerts').prepend(li);
  // Add marker
  if(a.location){
    const m = L.circleMarker([a.location.lat, a.location.lng], {radius:8}).addTo(map).bindPopup(a.msg);
    m.openPopup();
  }
}

async function refreshTourists(){
  const res = await fetch('/tourists');
  const data = await res.json();
  data.forEach(t => {
    if(t.last_location){
      if(!markers[t.id]){
        markers[t.id] = L.marker([t.last_location.lat, t.last_location.lng]).addTo(map)
          .bindPopup(`${t.name} — Safety: ${t.safety_score}`);
      }else{
        markers[t.id].setLatLng([t.last_location.lat, t.last_location.lng]);
      }
    }
  });
  const v = await fetch('/ledger/verify').then(r=>r.json());
  document.getElementById('chain').innerHTML = v.valid ? '<span class="pill">Ledger OK</span>' : '<span class="pill panic">Ledger CORRUPT</span>';
}

// WebSocket for live alerts
const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(wsProto + '://' + location.host + '/ws/alerts');
ws.onmessage = (ev) => {
  const msg = JSON.parse(ev.data);
  if(msg.type === 'init'){
    msg.data.forEach(addAlert);
  }else if(msg.type === 'alert'){
    addAlert(msg.data);
  }
};
</script>
</body>
</html>
